name: Build ServerLink

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  ARTIFACT_RETENTION_DAYS: 30

jobs:
  read-version:
    name: Read Version Information
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(grep '^SERVERLINK_VERSION=' VERSION | cut -d'=' -f2)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using ServerLink version: ${VERSION}"

  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-22.04
    needs: read-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            pkg-config

      - name: Build ServerLink
        run: |
          chmod +x ./build-scripts/linux/build.sh
          ./build-scripts/linux/build.sh x64 Release ON

      - name: Verify build
        run: |
          chmod +x ./build-scripts/common/verify.sh
          ./build-scripts/common/verify.sh dist/linux-x64 linux-x64

      - name: Run tests
        run: |
          chmod +x ./scripts/run_tests.sh
          BUILD_DIR=build-x64 ./scripts/run_tests.sh

      - name: Run benchmarks
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          chmod +x ./scripts/run_benchmarks.sh
          BUILD_DIR=build-x64 OUTPUT_FILE=benchmark-linux-x64.json PLATFORM=linux-x64 ./scripts/run_benchmarks.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serverlink-linux-x64
          path: dist/linux-x64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Upload benchmark results
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-linux-x64
          path: benchmark-linux-x64.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-22.04-arm
    needs: read-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            pkg-config

      - name: Build ServerLink
        run: |
          chmod +x ./build-scripts/linux/build.sh
          ./build-scripts/linux/build.sh arm64 Release ON

      - name: Verify build
        run: |
          chmod +x ./build-scripts/common/verify.sh
          ./build-scripts/common/verify.sh dist/linux-arm64 linux-arm64

      - name: Run tests
        run: |
          chmod +x ./scripts/run_tests.sh
          BUILD_DIR=build-arm64 ./scripts/run_tests.sh

      - name: Run benchmarks
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          chmod +x ./scripts/run_benchmarks.sh
          BUILD_DIR=build-arm64 OUTPUT_FILE=benchmark-linux-arm64.json PLATFORM=linux-arm64 ./scripts/run_benchmarks.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serverlink-linux-arm64
          path: dist/linux-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Upload benchmark results
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-linux-arm64
          path: benchmark-linux-arm64.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-2022
    needs: read-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ServerLink
        shell: pwsh
        run: |
          .\build-scripts\windows\build.ps1 -Architecture x64 -BuildType Release

      - name: Run tests
        shell: pwsh
        run: |
          $env:BUILD_DIR = "build-x64"
          .\scripts\run_tests.ps1 -BuildDir build-x64

      - name: Run benchmarks
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          .\scripts\run_benchmarks.ps1 -BuildDir build-x64 -OutputFile benchmark-windows-x64.json -Platform windows-x64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serverlink-windows-x64
          path: dist/windows-x64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Upload benchmark results
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-windows-x64
          path: benchmark-windows-x64.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-windows-arm64:
    name: Build Windows ARM64
    runs-on: windows-11-arm
    needs: read-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ServerLink
        shell: pwsh
        run: |
          .\build-scripts\windows\build.ps1 -Architecture arm64 -BuildType Release

      - name: Run tests
        shell: pwsh
        run: |
          $env:BUILD_DIR = "build-arm64"
          .\scripts\run_tests.ps1 -BuildDir build-arm64

      - name: Run benchmarks
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          .\scripts\run_benchmarks.ps1 -BuildDir build-arm64 -OutputFile benchmark-windows-arm64.json -Platform windows-arm64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serverlink-windows-arm64
          path: dist/windows-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Upload benchmark results
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-windows-arm64
          path: benchmark-windows-arm64.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos-x64:
    name: Build macOS x64 (Intel)
    runs-on: macos-15
    needs: read-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install cmake pkg-config

      - name: Build ServerLink
        run: |
          chmod +x ./build-scripts/macos/build.sh
          ./build-scripts/macos/build.sh x86_64 Release ON

      - name: Verify build
        run: |
          chmod +x ./build-scripts/common/verify.sh
          ./build-scripts/common/verify.sh dist/macos-x86_64 macos-x86_64

      - name: Run tests (via Rosetta 2)
        run: |
          chmod +x ./scripts/run_tests.sh
          BUILD_DIR=build-x86_64 ./scripts/run_tests.sh

      - name: Run benchmarks (via Rosetta 2)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          chmod +x ./scripts/run_benchmarks.sh
          BUILD_DIR=build-x86_64 OUTPUT_FILE=benchmark-macos-x64.json PLATFORM=macos-x64 ./scripts/run_benchmarks.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serverlink-macos-x64
          path: dist/macos-x86_64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Upload benchmark results
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-macos-x64
          path: benchmark-macos-x64.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos-arm64:
    name: Build macOS ARM64 (Apple Silicon)
    runs-on: macos-15
    needs: read-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install cmake pkg-config

      - name: Build ServerLink
        run: |
          chmod +x ./build-scripts/macos/build.sh
          ./build-scripts/macos/build.sh arm64 Release ON

      - name: Verify build
        run: |
          chmod +x ./build-scripts/common/verify.sh
          ./build-scripts/common/verify.sh dist/macos-arm64 macos-arm64

      - name: Run tests
        run: |
          chmod +x ./scripts/run_tests.sh
          BUILD_DIR=build-arm64 ./scripts/run_tests.sh

      - name: Run benchmarks
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          chmod +x ./scripts/run_benchmarks.sh
          BUILD_DIR=build-arm64 OUTPUT_FILE=benchmark-macos-arm64.json PLATFORM=macos-arm64 ./scripts/run_benchmarks.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serverlink-macos-arm64
          path: dist/macos-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Upload benchmark results
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-macos-arm64
          path: benchmark-macos-arm64.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  verify:
    name: Verify Build Artifacts
    runs-on: ubuntu-22.04
    needs:
      - read-version
      - build-linux-x64
      - build-linux-arm64
      - build-windows-x64
      - build-windows-arm64
      - build-macos-x64
      - build-macos-arm64
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display artifact structure
        run: |
          echo "=== Artifact Structure ==="
          find artifacts -type f -ls

      - name: Generate SHA256 checksums
        run: |
          echo "=== SHA256 Checksums ==="
          cd artifacts
          find . -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" -o -name "*.a" -o -name "*.lib" \) \
            -exec sha256sum {} \; | tee checksums.txt

      - name: Build summary
        run: |
          echo "## Build Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ServerLink Version:** ${{ needs.read-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Built Platforms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for platform in linux-x64 linux-arm64 windows-x64 windows-arm64 macos-x64 macos-arm64; do
            if [ -d "artifacts/serverlink-${platform}" ]; then
              echo "- ✅ ${platform}" >> $GITHUB_STEP_SUMMARY
              file_count=$(find "artifacts/serverlink-${platform}" -type f | wc -l)
              echo "  - Files: ${file_count}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ ${platform}" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat artifacts/checksums.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: artifacts/checksums.txt
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Checkout for benchmark scripts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts

      - name: Generate benchmark comparison report
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Create benchmarks directory with all benchmark files
          mkdir -p benchmarks
          for platform in linux-x64 linux-arm64 windows-x64 windows-arm64 macos-x64 macos-arm64; do
            if [ -f "artifacts/benchmark-${platform}/benchmark-${platform}.json" ]; then
              cp "artifacts/benchmark-${platform}/benchmark-${platform}.json" benchmarks/
            fi
          done

          # Generate comparison report
          python3 scripts/compare_benchmarks.py \
            --input-dir benchmarks \
            --output-md artifacts/benchmark_report.md \
            --output-json artifacts/benchmark_report.json \
            --version ${{ needs.read-version.outputs.version }}

          # Add benchmark summary to GitHub step summary
          if [ -f "artifacts/benchmark_report.md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Performance Benchmarks" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat artifacts/benchmark_report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload benchmark report
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report
          path: |
            artifacts/benchmark_report.md
            artifacts/benchmark_report.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  release:
    name: Create Release
    runs-on: ubuntu-22.04
    needs:
      - read-version
      - verify
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          cd artifacts
          for platform in linux-x64 linux-arm64 windows-x64 windows-arm64 macos-x64 macos-arm64; do
            if [ -d "serverlink-${platform}" ]; then
              zip -r "serverlink-${platform}.zip" "serverlink-${platform}"
            fi
          done

          # Copy benchmark report to artifacts root if available
          if [ -d "benchmark-report" ]; then
            cp benchmark-report/benchmark_report.md . 2>/dev/null || true
            cp benchmark-report/benchmark_report.json . 2>/dev/null || true
          fi

          # Copy individual benchmark results
          for platform in linux-x64 linux-arm64 windows-x64 windows-arm64 macos-x64 macos-arm64; do
            if [ -d "benchmark-${platform}" ]; then
              cp "benchmark-${platform}/benchmark-${platform}.json" . 2>/dev/null || true
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ServerLink ${{ needs.read-version.outputs.version }}
          body: |
            ## ServerLink v${{ needs.read-version.outputs.version }}

            High-performance message routing library with C++20 features.

            ### Features
            - **ROUTER socket pattern** - Fair-queueing, identity-based routing
            - **PUB/SUB pattern** - Topic-based publish/subscribe with pattern matching
            - **Multiple transports** - inproc, TCP, IPC (Unix)
            - **Cross-platform I/O** - epoll (Linux), select (Windows), kqueue (macOS/BSD)
            - **C++20 features** - Concepts, ranges, span, constexpr, spaceship operator
            - **47 tests** - Comprehensive test coverage

            ### Downloads
            | Platform | Architecture | I/O Backend | File |
            |----------|--------------|-------------|------|
            | Linux | x64 | epoll | `serverlink-linux-x64.zip` |
            | Linux | ARM64 | epoll | `serverlink-linux-arm64.zip` |
            | Windows | x64 | select | `serverlink-windows-x64.zip` |
            | Windows | ARM64 | select | `serverlink-windows-arm64.zip` |
            | macOS | x64 (Intel) | kqueue | `serverlink-macos-x64.zip` |
            | macOS | ARM64 (Apple Silicon) | kqueue | `serverlink-macos-arm64.zip` |

            ### Performance Benchmarks
            Cross-platform benchmark results are available:
            - `benchmark_report.md` - Human-readable comparison table
            - `benchmark_report.json` - Machine-readable full results
            - Individual platform results: `benchmark-{platform}.json`

            ### Verification
            All builds have been tested with 47 automated tests.
            See `checksums.txt` for SHA256 verification.
          files: |
            artifacts/serverlink-linux-x64.zip
            artifacts/serverlink-linux-arm64.zip
            artifacts/serverlink-windows-x64.zip
            artifacts/serverlink-windows-arm64.zip
            artifacts/serverlink-macos-x64.zip
            artifacts/serverlink-macos-arm64.zip
            artifacts/checksums/checksums.txt
            artifacts/benchmark_report.md
            artifacts/benchmark_report.json
            artifacts/benchmark-linux-x64.json
            artifacts/benchmark-linux-arm64.json
            artifacts/benchmark-windows-x64.json
            artifacts/benchmark-windows-arm64.json
            artifacts/benchmark-macos-x64.json
            artifacts/benchmark-macos-arm64.json
          draft: false
          prerelease: false
